<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LifeVault Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0b1020;
            color: #f5f5f5;
        }
        header {
            padding: 16px 24px;
            border-bottom: 1px solid #242b3d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #111628;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        header .env-pill {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #3b425a;
            color: #9fa6c9;
        }
        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px 24px 24px;
        }
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: #131929;
            border-radius: 8px;
            border: 1px solid #242b3d;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .panel h2 {
            margin: 0 0 4px 0;
            font-size: 16px;
            color: #e5e7ff;
        }
        label {
            font-size: 13px;
            color: #c3c7e8;
            display: block;
            margin-bottom: 4px;
        }
        textarea, select, input[type="text"] {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #303853;
            background: #0b1020;
            color: #f5f5f5;
            padding: 8px 10px;
            font-size: 14px;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        select {
            height: 34px;
        }
        button {
            border-radius: 6px;
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-primary {
            background: #2563eb;
            color: #f9fafb;
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-outline {
            background: transparent;
            color: #e5e7ff;
            border: 1px solid #3b425a;
        }
        .row {
            display: flex;
            gap: 8px;
        }
        .row > div {
            flex: 1;
        }
        .status {
            font-size: 12px;
            color: #9fa6c9;
        }
        .response-box {
            background: #0b1020;
            border-radius: 6px;
            border: 1px solid #242b3d;
            padding: 10px;
            min-height: 120px;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #1e293b;
            color: #cbd5f5;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .small-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #9fa6c9;
        }
    </style>
</head>
<body>
<header>
    <h1>LifeVault Console</h1>
    <div class="env-pill">Frontend → Orchestrator / Meal Log / Fasting (HTTP)</div>
</header>

<main>
    <!-- Fasting Tracker -->
    <section class="panel">
        <h2>Fasting Tracker</h2>

        <div class="row" style="justify-content: space-between; align-items: center;">
            <button id="startFastBtn" class="btn-primary">Start fast</button>
            <button id="endFastBtn" class="btn-outline">End fast</button>
        </div>

        <div class="status" id="fastStatus">Not fasting.</div>

        <div>
            <div class="small-label">Current fasting stage</div>
            <div id="fastStage" class="response-box">
                When you start a fast, you’ll see an hour‑by‑hour description of what’s happening in your body here.
            </div>
        </div>
    </section>

    <!-- Quick Meal Log -->
    <section class="panel">
        <h2>Quick Meal Log (direct to Azure)</h2>

        <div class="row">
            <div>
                <label for="mealType">Meal type</label>
                <select id="mealType">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
            <div>
                <label for="mealUserId">User ID</label>
                <input id="mealUserId" type="text" placeholder="defaultuser">
            </div>
        </div>

        <div>
            <label for="mealItems">What did you eat?</label>
            <input id="mealItems" type="text"
                   placeholder="Example: 3 eggs, avocado, black coffee">
        </div>

        <div class="row" style="justify-content: space-between; align-items: center;">
            <button id="mealLogBtn" class="btn-primary">Log meal</button>
            <div class="status" id="mealStatus">Idle</div>
        </div>
    </section>

    <!-- LEFT: Request builder -->
    <section class="panel">
        <h2>Request</h2>

        <div>
            <label for="inputText">What do you want LifeVault to do?</label>
            <textarea id="inputText"
                      placeholder="Example: Plan my next 7 days to balance coding, workouts, and recovery."></textarea>
        </div>

        <div class="row">
            <div>
                <label for="persona">Persona</label>
                <select id="persona">
                    <option value="dev">Developer Shane</option>
                    <option value="vitality">Vitality Shane</option>
                    <option value="wisdom">Wisdom Shane</option>
                </select>
            </div>
            <div>
                <label for="intent">Intent</label>
                <select id="intent">
                    <option value="plan_day">Plan day</option>
                    <option value="plan_sprint">Plan dev sprint</option>
                    <option value="optimize_energy">Optimize energy</option>
                    <option value="reflect">Reflect / wisdom</option>
                    <option value="log_event">Log event</option>
                    <option value="big_decision">Big decision</option>
                </select>
            </div>
        </div>

        <div>
            <label for="userId">User ID (optional)</label>
            <input id="userId" type="text" placeholder="e.g., shane-dev-001">
        </div>

        <div class="row" style="justify-content: space-between; align-items: center;">
            <button id="runBtn" class="btn-primary">Run with LifeVault</button>
            <button id="exampleBtn" class="btn-outline">Use example request</button>
        </div>

        <div class="status" id="statusText">Idle</div>
    </section>

    <!-- RIGHT: Response viewer -->
    <section class="panel">
        <h2>Response</h2>

        <div>
            <div class="small-label">Final answer</div>
            <div id="finalResponse" class="response-box">
                Run a request to see LifeVault orchestrator output here.
            </div>
        </div>

        <div>
            <div class="small-label" style="margin-bottom: 4px;">Agents involved</div>
            <div id="agentsList"></div>
        </div>
    </section>
</main>

<script>
    // Orchestrator HTTP endpoint
    const ORCHESTRATOR_ENDPOINT = "http://localhost:3000/api/orchestrate";

    // Direct meal logging endpoint (same logMeal Azure Function used in your tests)
    const MEAL_LOG_ENDPOINT = "https://lifevault-api.azurewebsites.net/api/logMeal";

    const runBtn = document.getElementById('runBtn');
    const exampleBtn = document.getElementById('exampleBtn');
    const inputText = document.getElementById('inputText');
    const persona = document.getElementById('persona');
    const intent = document.getElementById('intent');
    const userId = document.getElementById('userId');
    const statusText = document.getElementById('statusText');
    const finalResponse = document.getElementById('finalResponse');
    const agentsList = document.getElementById('agentsList');

    // Quick meal log elements
    const mealLogBtn  = document.getElementById('mealLogBtn');
    const mealTypeSel = document.getElementById('mealType');
    const mealUserId  = document.getElementById('mealUserId');
    const mealItems   = document.getElementById('mealItems');
    const mealStatus  = document.getElementById('mealStatus');

    // Fasting tracker elements
    const startFastBtn = document.getElementById('startFastBtn');
    const endFastBtn   = document.getElementById('endFastBtn');
    const fastStatus   = document.getElementById('fastStatus');
    const fastStage    = document.getElementById('fastStage');

    let fastTimerInterval = null;

    function getFastingDescription(hours) {
        if (hours < 0.1) {
            return "You’re not in a fast yet. Once you start, you’ll see what’s happening in your body hour by hour based on typical intermittent fasting physiology.";
        } else if (hours < 4) {
            return "0–4 hours fasted: You’re in the post‑meal state. Digestion and absorption are active, blood sugar and insulin are elevated, and you’re primarily burning the food from your last meal. A mild ‘food coma’ or energy dip can happen if that meal was large or high in refined carbs.";
        } else if (hours < 8) {
            return "4–8 hours fasted: Insulin is falling and your body is finishing the last of the meal‑derived glucose. Your liver releases stored glycogen to keep blood sugar stable. Cravings often fade and energy becomes steadier than right after eating.";
        } else if (hours < 12) {
            return "8–12 hours fasted: You’re in a late post‑absorptive phase. Your body increasingly taps liver glycogen and starts ramping up fat breakdown. Growth‑supporting hormones rise relative to the fed state, helping preserve lean mass. Hunger usually comes in waves that pass if you ride them out for 10–20 minutes.";
        } else if (hours < 16) {
            return "12–16 hours fasted: You’re shifting more toward fat‑led metabolism. Glycogen is lower, so you’re burning more stored fat and producing more ketones. Many people experience clearer thinking and steadier focus here, with lower inflammatory signals than in a constant snacking pattern.";
        } else if (hours < 20) {
            return "16–20 hours fasted: You’re in a deeper fasting window. Fat burning is prominent, ketones provide more brain fuel, and cellular clean‑up processes like autophagy begin to ramp up compared with normal feeding. This is where a ‘fasting high’ is common—lighter body feeling, sharp mind, and less reactive hunger.";
        } else if (hours < 24) {
            return "20–24 hours fasted: You’re relying heavily on stored fat and ketones, with very low insulin and typically improved insulin sensitivity compared to frequent grazing. Stress‑response pathways help maintain alertness and protect lean tissue. Cellular repair and recycling processes are more active than baseline, one proposed mechanism for fasting’s long‑term health effects.";
        } else if (hours < 48) {
            return "24–48 hours fasted: You’re solidly in extended fasting. Fat and ketones are the dominant fuels, liver glycogen is largely depleted, and autophagy and other cellular recycling processes remain elevated compared with normal eating. Many people report pronounced mental clarity and a very light, empty‑but‑energized body sensation during this window.";
        } else if (hours < 72) {
            return "48–72 hours fasted: Ketone levels are typically high, and fat stores are the primary energy source. Cellular stress‑response pathways, including autophagy and antioxidant defenses, stay strongly engaged. This window is often associated with a deep internal reset feeling as your body continues prioritizing repair and cleanup over digestion.";
        } else if (hours < 168) { // up to 7 days
            return "72 hours to 7 days fasted: You’re in prolonged water‑fast territory. Body fat becomes the main calorie source, ketones fuel most brain function, and multiple hormonal and cellular repair systems operate in a sustained, fasting‑adapted mode. This period is often described as a powerful reset for appetite, food habits, and the relationship between mental clarity and energy.";
        } else if (hours < 240) { // 7–10 days
            return "7–10 days fasted: You are in a very deep, extended fasting state. Your metabolism is thoroughly adapted to running on stored fat and ketones, and long‑term repair‑oriented processes remain active. Many people notice a profound shift in how they perceive hunger, taste, and their overall sense of mental and emotional clarity during this phase.";
        } else {
            return "10+ days fasted: This represents an extreme duration where fat and ketones carry almost all energy needs and fasting‑adapted hormonal and cellular patterns are sustained over many days. It is often described as a period of intense inner reset, with ongoing emphasis on repair, conservation, and highly efficient use of body fuel reserves.";
        }
    }

    function updateFastingUI() {
        const stored = localStorage.getItem("lifevault.fastStart");
        if (!stored) {
            fastStatus.textContent = "Not fasting.";
            fastStage.textContent = "When you start a fast, you’ll see an hour‑by‑hour description of what’s happening in your body here.";
            return;
        }
        const startTime = new Date(stored);
        const now = new Date();
        const diffMs = now - startTime;
        if (diffMs <= 0) {
            fastStatus.textContent = "Not fasting.";
            fastStage.textContent = "When you start a fast, you’ll see an hour‑by‑hour description of what’s happening in your body here.";
            return;
        }
        const hours = diffMs / 3600000;
        const wholeHours = Math.floor(hours);
        const minutes = Math.floor((hours - wholeHours) * 60);

        fastStatus.textContent = `Fasting for ${wholeHours}h ${minutes}m (since ${startTime.toLocaleTimeString()}).`;
        fastStage.textContent = getFastingDescription(hours);
    }

    function startFastingTimer() {
        if (fastTimerInterval) clearInterval(fastTimerInterval);
        updateFastingUI();
        fastTimerInterval = setInterval(updateFastingUI, 60000); // update every minute
    }

    // Initialize fasting state on load
    document.addEventListener("DOMContentLoaded", () => {
        const stored = localStorage.getItem("lifevault.fastStart");
        if (stored) {
            startFastingTimer();
        } else {
            updateFastingUI();
        }
    });

    startFastBtn.addEventListener("click", () => {
        const nowIso = new Date().toISOString();
        localStorage.setItem("lifevault.fastStart", nowIso);
        startFastingTimer();
    });

    endFastBtn.addEventListener("click", () => {
        localStorage.removeItem("lifevault.fastStart");
        if (fastTimerInterval) clearInterval(fastTimerInterval);
        fastStatus.textContent = "Fast ended.";
        fastStage.textContent = "Fast ended. When you start a new fast, this panel will show your hour‑by‑hour physiology again.";
    });

    exampleBtn.addEventListener('click', () => {
        inputText.value = "Plan my next 7 days so I can make serious progress on LifeVault, stay on top of MSSA, and not burn out physically.";
        persona.value = "dev";
        intent.value = "plan_sprint";
        statusText.textContent = "Example loaded.";
    });

    runBtn.addEventListener('click', async () => {
        const text = inputText.value.trim();
        if (!text) {
            alert("Please enter a request for LifeVault.");
            return;
        }

        const payload = {
            userId: userId.value.trim() || "shane-dev-001",
            persona: persona.value,
            intent: intent.value,
            inputText: text,
            uiContext: {
                source: "web-console",
                version: "v1",
                timestamp: new Date().toISOString()
            }
        };

        runBtn.disabled = true;
        statusText.textContent = "Calling LifeVault orchestrator...";
        finalResponse.textContent = "Thinking...";
        agentsList.innerHTML = "";

        try {
            if (ORCHESTRATOR_ENDPOINT.includes("YOUR_ENDPOINT_HERE")) {
                await new Promise(r => setTimeout(r, 800));
                finalResponse.textContent =
                    "This is a demo response. Replace ORCHESTRATOR_ENDPOINT in console.html with your real Azure Function or API URL.\n\n" +
                    "Payload that would be sent:\n" + JSON.stringify(payload, null, 2);
                agentsList.innerHTML =
                    '<span class="badge">Vitality (simulated)</span>' +
                    '<span class="badge">Analytics (simulated)</span>' +
                    '<span class="badge">Memory (simulated)</span>' +
                    '<span class="badge">Wisdom (simulated)</span>';
                statusText.textContent = "Demo mode: endpoint not configured yet.";
            } else {
                const res = await fetch(ORCHESTRATOR_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    throw new Error("HTTP " + res.status + " " + res.statusText);
                }

                const data = await res.json();

                finalResponse.textContent = data.finalResponse || "(No finalResponse field returned.)";

                agentsList.innerHTML = "";
                if (Array.isArray(data.agentSummaries)) {
                    data.agentSummaries.forEach(a => {
                        const span = document.createElement("span");
                        span.className = "badge";
                        span.textContent = a.agent + (a.summary ? " – " + a.summary : "");
                        agentsList.appendChild(span);
                    });
                } else {
                    agentsList.innerHTML = '<span class="badge">No agent summary data.</span>';
                }

                statusText.textContent = "Response received.";
            }
        } catch (err) {
            console.error(err);
            finalResponse.textContent = "Error calling orchestrator: " + err.message;
            agentsList.innerHTML = '<span class="badge">Error</span>';
            statusText.textContent = "Error.";
        } finally {
            runBtn.disabled = false;
        }
    });

    // Quick Meal Log handler – posts directly to logMeal Azure Function
    mealLogBtn.addEventListener('click', async () => {
        const items = mealItems.value.trim();
        if (!items) {
            alert("Please enter what you ate.");
            return;
        }

        const userIdVal = mealUserId.value.trim() || "defaultuser";
        const mealType = mealTypeSel.value;

        const payload = {
            userId: userIdVal,
            timestamp: new Date().toISOString(),
            mealType,
            foodItems: items,
            gradeAnalysis: ""
        };

        mealLogBtn.disabled = true;
        mealStatus.textContent = "Logging meal...";

        try {
            const res = await fetch(MEAL_LOG_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                throw new Error("HTTP " + res.status + " " + res.statusText);
            }

            const data = await res.json();
            mealStatus.textContent = "Meal logged! id=" + (data.id || "ok");
            mealItems.value = "";
        } catch (err) {
            console.error(err);
            mealStatus.textContent = "Error: " + err.message;
        } finally {
            mealLogBtn.disabled = false;
        }
    });
</script>
</body>
</html>
